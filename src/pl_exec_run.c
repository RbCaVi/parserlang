#include "pv/pv_install.h"

#include "pv/pv_to_string.h"

#include "pl/pl_dump.h"
#include "pl/pl_bytecode.h"
#include "pl/pl_exec.h"
#include "pl/pl_func.h"
#include "pl/pl_iter.h"

#include "plc/plc_exe.h"

#include "pv_install.h"
#include "pv_array.h"
#include "pl_bytecode.h"
#include "pl_func.h"
#include "pl_dump.h"
#include "plc_parsetree.h"
#include "plc_codegen.h"
#include "plc_exe.h"

#include <stdio.h>

#include <emscripten/emscripten.h>

EMSCRIPTEN_KEEPALIVE void run(/* char *data */) {
unsigned char data[] = {
  0x00, 0x00, 0x00, 0x00, 0x08, 0x00, 0x00, 0x00, 0x11, 0x00, 0x00, 0x00,
  0x33, 0x00, 0x00, 0x00, 0x33, 0x00, 0x00, 0x00, 0x33, 0x00, 0x00, 0x00,
  0x33, 0x00, 0x00, 0x00, 0x33, 0x00, 0x00, 0x00, 0x33, 0x00, 0x00, 0x00,
  0x33, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00,
  0x78, 0x0a, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00,
  0x00, 0x01, 0x00, 0x00, 0x00, 0x79, 0x07, 0x00, 0x00, 0x00, 0x08, 0x00,
  0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x0d, 0x00, 0x00, 0x00, 0x09, 0x00,
  0x00, 0x00, 0x0b, 0x00, 0x00, 0x00, 0x05, 0x00, 0x00, 0x00, 0x70, 0x72,
  0x69, 0x6e, 0x74, 0x0b, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x78,
  0x03, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x79, 0x07, 0x00, 0x00,
  0x00, 0x08, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x0d, 0x00, 0x00,
  0x00, 0x09, 0x00, 0x00, 0x00, 0x0b, 0x00, 0x00, 0x00, 0x05, 0x00, 0x00,
  0x00, 0x70, 0x72, 0x69, 0x6e, 0x74, 0x0b, 0x00, 0x00, 0x00, 0x01, 0x00,
  0x00, 0x00, 0x78, 0x03, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x79,
  0x07, 0x00, 0x00, 0x00, 0x08, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00,
  0x0d, 0x00, 0x00, 0x00, 0x09, 0x00, 0x00, 0x00, 0x0b, 0x00, 0x00, 0x00,
  0x05, 0x00, 0x00, 0x00, 0x70, 0x72, 0x69, 0x6e, 0x74, 0x0b, 0x00, 0x00,
  0x00, 0x01, 0x00, 0x00, 0x00, 0x78, 0x03, 0x00, 0x00, 0x00, 0x01, 0x00,
  0x00, 0x00, 0x79, 0x07, 0x00, 0x00, 0x00, 0x08, 0x00, 0x00, 0x00, 0x02,
  0x00, 0x00, 0x00, 0x0d, 0x00, 0x00, 0x00, 0x09, 0x00, 0x00, 0x00, 0x0b,
  0x00, 0x00, 0x00, 0x05, 0x00, 0x00, 0x00, 0x70, 0x72, 0x69, 0x6e, 0x74,
  0x0b, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x78, 0x03, 0x00, 0x00,
  0x00, 0x01, 0x00, 0x00, 0x00, 0x79, 0x07, 0x00, 0x00, 0x00, 0x08, 0x00,
  0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x0d, 0x00, 0x00, 0x00, 0x09, 0x00,
  0x00, 0x00, 0x0b, 0x00, 0x00, 0x00, 0x05, 0x00, 0x00, 0x00, 0x70, 0x72,
  0x69, 0x6e, 0x74, 0x0b, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x78,
  0x03, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x79, 0x07, 0x00, 0x00,
  0x00, 0x08, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x0d, 0x00, 0x00,
  0x00, 0x09, 0x00, 0x00, 0x00, 0x0b, 0x00, 0x00, 0x00, 0x05, 0x00, 0x00,
  0x00, 0x70, 0x72, 0x69, 0x6e, 0x74, 0x0b, 0x00, 0x00, 0x00, 0x01, 0x00,
  0x00, 0x00, 0x78, 0x03, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x79,
  0x07, 0x00, 0x00, 0x00, 0x08, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00,
  0x0d, 0x00, 0x00, 0x00, 0x09, 0x00, 0x00, 0x00, 0x0b, 0x00, 0x00, 0x00,
  0x05, 0x00, 0x00, 0x00, 0x70, 0x72, 0x69, 0x6e, 0x74, 0x0b, 0x00, 0x00,
  0x00, 0x01, 0x00, 0x00, 0x00, 0x78
};

	char *data2;

	{
		pv_install();
		pl_func_install();
		pl_iter_install();

		stmt s = parse_stmt(data);

		plc_codegen_context *c = plc_codegen_context_new();

		pl_bytecode_builder *b = plc_codegen_stmt(c, &s);
		// in case control flow reaches the end, return null
		b = pl_bytecode_dup_builder(b); // the original is freed by plc_codegen_context_free(c)
		pl_bytecode_builder_add(b, PUSHNULL, {});
		pl_bytecode_builder_add(b, RET, {});
		pl_bytecode_builder_add(b, GRET, {});
		pl_bytecode code = pl_bytecode_from_builder(b);

		printf("top level bytecode:\n");
		pl_bytecode_dump(code);

		printf("aaa:\n");
		pv globals = plc_codegen_context_get_globals(c);

		printf("bbb:\n");
		plc_exe exe;

		exe.main = pl_func(code);

		exe.glen = pv_array_length(pv_copy(globals));
		exe.globals = malloc(exe.glen * sizeof(pv));

		printf("bbb:\n");
		pv_array_foreach(globals, i, v) {
			if (pv_get_kind(v) == func_kind) {
				printf("function at %i bytecode:\n", i);
				pl_bytecode bytecode = pl_func_get_bytecode(pv_copy(v));
				pl_bytecode_dump(bytecode);
				pl_bytecode_free(bytecode);
			}
			exe.globals[i] = pv_copy(v);
		}

		printf("bbb:\n");
		pv_free(globals);

		data2 = plc_exe_dump_str(exe);

		for (unsigned int i = 0; i < exe.glen; i++) {
			pv_free(exe.globals[i]);
		}
		free(exe.globals);

		printf("bbb:\n");
		plc_codegen_context_free(c);

		free_stmt(s);
	}

		printf("cccccccccccccc:\n");









	plc_exe e = pl_exe_parse(data2);

		printf("f:\n");
	pv main = e.main;

	pl_bytecode bytecode = pl_func_get_bytecode(pv_copy(main));
	printf("\nmain bytecode:\n");
	pl_bytecode_dump(bytecode);
	printf("\n");

	pl_state *pl = pl_state_new();
	pl->globals = e.globals;

	pv ret = pl_func_call(main, pl);
	printf("return value:\n");
	pl_dump_pv(pv_copy(ret));
	char *s = pv_to_string(ret);
	printf("%s\n", s);
	free(s);
	printf("\n");

	for (unsigned int i = 0; i < e.glen; i++) {
		printf("global %i:\n", i);
		pl_dump_pv(pv_copy(pl->globals[i]));
		printf("\n");
	}

	for (unsigned int i = 0; i < e.glen; i++) {
		pv_free(pl->globals[i]);
	}
	free(pl->globals);

	pl_state_free(pl);
}